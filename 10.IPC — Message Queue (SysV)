/* msgq_ipc.c
   Compile: gcc msgq_ipc.c -o msgq_ipc
   Demonstrates a sender and receiver using SysV message queue.
*/
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <string.h>
#include <unistd.h>
#include <sys/wait.h>

struct msgbuf { long mtype; char mtext[256]; };

int main(){
    key_t key = ftok(".", 'Q');
    int mqid = msgget(key, IPC_CREAT | 0666);
    if(mqid < 0){ perror("msgget"); return 1;}
    pid_t pid = fork();
    if(pid==0){
        // child: receiver
        struct msgbuf r;
        msgrcv(mqid, &r, sizeof(r.mtext), 1, 0);
        printf("Receiver got: %s\n", r.mtext);
        return 0;
    } else {
        // parent: sender
        struct msgbuf s;
        s.mtype = 1;
        printf("Enter message to send: ");
        fgets(s.mtext, sizeof(s.mtext), stdin);
        s.mtext[strcspn(s.mtext,"\n")] = 0;
        msgsnd(mqid, &s, strlen(s.mtext)+1, 0);
        wait(NULL);
        msgctl(mqid, IPC_RMID, NULL);
    }
    return 0;
}
